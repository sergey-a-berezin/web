// Copyright 2020 Sergey Berezin

// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at

//     http://www.apache.org/licenses/LICENSE-2.0

// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

var sample_generic = 
  {"title":{"v":"The Most Generic Story of All Times"},"hero_name":{"v":"Good Boy"},"hero_desc":{"v":"good ordinary man"},"vil_desc":{"v":"evil and greedy"},"vil_name":{"v":"Bad Guy"},"vil_goal":{"v":"to do bad things that would ruin the Good Boy's life"},"vil_power":{"v":"very bad and very powerful"},"catalyst":{"v":"something unusual happened"},"debate":{"v":"thought \"who am I to change anything anyway?\""},"ally":{"v":"his best friend and mentor"},"break2":{"v":"something really dramatic happened"},"fun":{"v":"decided it is time to do something about it. He goes on through a number of obstacles and learns a number of new skills"},"b_story":{"v":"Good Boy meets Beautiful Girl"},"b_evolve":{"v":"Good Boy and Beautiful Girl become close and start doing cool things together"},"b_end":{"v":"Beautiful Girl helps Good Boy to come up with a way to beat Bad Guy"},"midpoint":{"v":"Bad Guy notices that Good Boy is becoming a nuisance for him, and decides to get rid of him"},"bad_guys":{"v":"Bad Guy starts to really hate Good Boy, because Good Boy is still in his way. He gets angry and throws more bad things at Good Boy"},"cave":{"v":"Bad Guy beats Good Boy, and Good Boy is now totally defeated and depressed."},"battle":{"v":"Good Boy uses his newly acquired skills to outsmart the Bad Guy and takes him down"},"char_test":{"v":"Now Good Boy and Beautiful Girl are the happiest family in town, and they are keeping the Bad Guy in check so he can no longer do his evil things around here"},"hero_need":{"v":"to be with Beautiful Girl and do really cool things together"},"hero_want":{"v":"to get things back on track and keep on living the good old way"},"hero_routine":{"v":"He was living an ordinary life and doing his everyday work."}};

var sample_cinderella = 
  {"title":{"v":"Fairy Tale: Cinderella"},"hero_name":{"v":"Cinderella"},"hero_desc":{"v":"poor little girl"},"hero_want":{"v":"to be happy"},"vil_desc":{"v":"evil witch"},"vil_name":{"v":"Stepmother"},"vil_goal":{"v":"her daughters to be better than Cinderella"},"vil_power":{"v":"had everybody in the house under control, including Cinderella's father"},"catalyst":{"v":"the king announced a ball where his prince would look for a queen, and everyone in the kingdom was invited"},"debate":{"v":"didn't have good clothes, and her stepmother gave her too many chores to do"},"ally":{"v":"fairy godmother"},"break2":{"v":"fairy godmother gave Cinderella a beautiful dress, crystal shoes, and a coach with horses"},"fun":{"v":"was having a good time at the ball, and became quite a hit"},"b_story":{"v":"Cinderella meets the prince who falls in love with her and wants to know her name"},"b_evolve":{"v":"The prince is looking for Cinderella all over the kingdom, trying the crystal shoe on all the unmarried young girls - the only clue he's got"},"b_end":{"v":"Cinderella loves the prince, and decides to disobey her Stepmother and come out for the prince to see her"},"midpoint":{"v":"the clock chimes midnight, and the coach turns into a pumpkin"},"bad_guys":{"v":"Stepmother notices Cinderella's success and orders her to stay in house"},"cave":{"v":"Cinderella cannot come out and meet the prince, who has tried the shoe on her step-sisters, but failed, and is about to leave"},"battle":{"v":"Cinderella tries the shoe - and not only it fits, but she produces the second shoe, just like the first one"},"char_test":{"v":"Cinderella agrees to marry the prince. and they live happily ever after"},"hero_need":{"v":"to marry the prince"},"hero_routine":{"v":"She did all the chores around the house and was always dirty in cinders - that's why they called her Cinderella."}};

var sample_matrix = 
  {"title":{"v":"Sci-Fi: The Matrix"},"hero_name":{"v":"Neo"},"hero_desc":{"v":"underground hacker"},"hero_want":{"v":"to know what the Matrix is"},"vil_desc":{"v":"the machines represented by the Agents, and in particular"},"vil_name":{"v":"Agent Smith"},"vil_goal":{"v":"to keep Neo in check, and to wipe out human rebels"},"vil_power":{"v":"was extremely fast, strong, can appear anywhere, and therefore, is practically invincible"},"catalyst":{"v":"Agent Smith with other agents apprehends Neo, just as Morpheus tries to contact Neo. Neo is shaken"},"debate":{"v":"still can't believe this is really happening to him"},"ally":{"v":"Morpheus"},"break2":{"v":"Neo finally meets Morpheus, and is offered a choice: blue pill or red pill. Neo takes the red pill, and finds himself in a huge gloomy futuristic farm operated by scary machines. He is flushed into the lake, where a flying ship picks him up"},"fun":{"v":"recovers, and Morpheus explains him what the Matrix is. Neo learn various skills, including kung fu, jumping between buildings, and other cool Matrix things. It is time for Neo to go see the Oracle, who tells Neo that he will have to make a hard choice between his life and Morpheus's"},"b_story":{"v":"Trinity is falling in love with Neo. She cares for Neo perhaps more than what Cypher, another crew member, considers adequate"},"b_evolve":{"v":"Trinity is starting to see that Neo is starting to look more and more like The One. And, like Morpheus, she is beginning to believe in Neo. Together they free Morpheus from the Agents"},"b_end":{"v":"Trinity is crying over Neo's body, as the machines are breaking into the ship. In her arms, Neo answers to her kiss by coming back to life, for the first time seeing who he really is"},"midpoint":{"v":"as Neo is coming back from the Oracle, Cypher betrays them. The Agents attack, kill several people, and capture Morpheus"},"bad_guys":{"v":"Neo and Trinity return to the Matrix to save Morpheus. They have a spectacular fight in the entrance hall. Neo demonstrates near-agent abilities, but still not enough to take on an agent"},"cave":{"v":"He is trapped in the Matrix, being pursued by the agents, and Agent Smith in particular. And even though Neo fights Agent Smith at the train station, he gets shot when he nearly reaches for the phone"},"hero_need":{"v":"to become who he really is"},"battle":{"v":"Now he easily fights off Agent Smith, and more than that - he completely destroys him. So much so that other agents flee from the scene. At the last moment, Neo picks up the phone and returns to the real world just in time for the EMP to destroy the attacking machines"},"char_test":{"v":"Neo is now The One, and can do anything he wants in the Matrix - even fly like a superman"},"hero_routine":{"v":"By day, he had a job at a large software company with strict rules, and by night he was doing some shadow hacker's business."}};

var sample_titanic = 
  {"title":{"v":"Love Story: Titanic"},"hero_name":{"v":"Rose"},"hero_desc":{"v":"beautiful and kind girl"},"hero_want":{"v":"to stop her marriage with Caledon"},"vil_desc":{"v":"rich and arrogant"},"vil_name":{"v":"Caledon"},"vil_goal":{"v":"marry Rose"},"vil_power":{"v":"got the approval from the families and arranged everything for the wedding"},"catalyst":{"v":"Jack, a simple young man, wins a ticket for a trip to America on Titanic"},"debate":{"v":"didn't see any way out, and was considering to commit a suicide by jumping off the deck"},"ally":{"v":"Jack"},"break2":{"v":"on her trip to America onboard of Titanic, Rose meets Jack, who convinces her not to jump"},"fun":{"v":"falls in love with Jack, and they spend a good deal of time going around the great ship doing everything what lovers do. Jack paints a nude portrait of Rose, then they make love on the back seat of a car"},"b_story":{"v":"as the lookouts are busy watching Rose and Jack, Titanic hits an iceberg and punctures the hull."},"midpoint":{"v":"The passengers learn about the clash with the iceberg, and together with Rose and Jack are worried about their safety. While the ship is severely damaged, the captain assures it is unsinkable, and there is no reason to worry"},"bad_guys":{"v":"When Rose and Jack learn about the danger, they try to warn Caledon, but he instead accuses Jack of stealing the Blue Diamond"},"cave":{"v":"Rose is forced to stay with Caledon, but is worried about Jack. She knows Jack can be in danger, but it seems, there is nothing she can do to save him"},"battle":{"v":"Rose escapes from the boat and runs down to find Jack. With difficulty, she helps to rescue Jack from a flooded cell and get him on the upper deck. But the boats have already left, and after the dramatic sinking of the ship, Rose and Jack's only hope is to find something to float on the surface and wait for the rescue boat"},"char_test":{"v":"Jack finds a piece of debris and puts Rose on this makeshift raft. He himself dies in the cold water. When Rose is rescued, she calls herself Rose Dawson (Jack's last name). She catches a glimpse of Caledon on the rescue ship, but evades him, and he does not notice her. Many years later, Rose (now a very old lady) finishes the story and drops the long lost diamond into the sea. Later she dies peacefully in her sleep"},"hero_need":{"v":"to be with Jack, to be who she is, and live life on her own terms"},"b_end":{"v":"The ship has only a few minutes left before it goes down. People panic, Caledon is distracted"},"b_evolve":{"v":"the \"unsinkable\" ship slowly begins to sink"},"hero_routine":{"v":"She was about to marry Caledon against her will, and they were boarding a ship called Titanic for their trip to America."}};

var sample_wolf = 
  {"title": {"v":"Wolf and seven goats"},
   "hero_name":{"v":"Seven goats"},
   "hero_desc":{"v":"small and helpless"},
   "hero_want":{"v":"to eat the grass"},
   "vil_desc":{"v":"scary and hungry"},
   "vil_name":{"v":"Wolf"},
   "vil_goal":{"v":"eat the seven goats"},
   "vil_power":{"v":"is big, strong and ruthless"},
   "catalyst":{"v":"wolf was particularly hungry and howled in the dark of the night"},
   "debate":{"v":"thought the wolf is far away, and went back to sleep"},
   "ally":{"v":"Shepard "},
   "break2":{"v":"Wolf appears right on the pasture with seven goats"},
   "fun":{"v":"run away and hide in a cave"},
   "b_story":{"v":"Shepard meets a beautiful lady and is walking with her in the forest, looking for a quiet cave to stop by and sit by the romantic fire"},
   "b_evolve":{"v":"Shepard finds a very nice looking cave, sets up a fire, and he and his girlfriend are having a good time"},
   "b_end":{"v":"Shepard happened to find exactly the same cave where the seven goats were hiding, and the Wolf couldn't enter because he was afraid of the fire"},
   "midpoint":{"v":"The wolf sniffs the seven goats in the cave, and howls right next to the entrance"},
   "bad_guys":{"v":"The cave is wide enough for the wolf to enter, and not big enough for the seven goats to hide away. The wolf would certainly find them and eat them"},
   "cave":{"v":"Seven goats have crowded in a dark corner and sit quietly, barely breathing, with no hope left"},
   "battle":{"v":"The Shepard sees the wolf entering the cave and throws burning coals at him. The wolf gets burned and runs away."},
   "char_test":{"v":"Shepard is happy to see the seven goats. He makes some milk for his new girlfriend, and they all live long and happy."}};

var samples = 
  [sample_generic,
   sample_matrix,
   sample_cinderella,
   sample_titanic,
   // sample_wolf
   ];

var questions =
  [{'id':'title','text':'What is the title of your story?'},
   {"id":"hero_name","text":"<strong>Act I, Setup:</strong> What is the name of your hero?"},
   {"id":"hero_desc","text":"Describe your hero in two words (king, poor fisherman, pretty little girl, mad scientist, etc.)"},
   {"id":"hero_routine","text":"What your hero's initial routine? (optional)"},
    {"id":"catalyst","text":"<strong>Catalyst:</strong> What is the event that irreversibly changes the world as the hero knows it?"},
    {"id":"hero_want","text":"What does the hero want at the beginning?"},
    {"id":"debate","text":"How does the hero refuse the call? What does he/she do as an excuse not to go after the goal?"},
    {"id":"vil_desc","text":"Describe your villain in two words (fire-breathing dragon, micromanaging boss, etc.)"},
    {"id":"vil_name","text":"What is the villain's name?"},
    {"id":"vil_goal","text":"What is the vilain's goal that conflicts with the hero's goal?"},
    {"id":"vil_power","text":"What is the villain's main power that makes him/her nearly invincible?"},
    {"id":"ally","text":"Who is the hero's main ally / aid / helper?"},
    {"id":"break2","text":"<strong>Act II:</strong> What happens to the hero that convinces him/her to take the bold step into the new world?","v":"fairy godmother gave Cinderella a beautiful dress, crystal shoes, and a coach with horses"},
    {"id":"fun","text":"Fun and Games: what happens to the hero in the new world? What does he/she learn, what are the small victories he/she achieves, and what initial obstacles he/she overcomes?","v":"was having a ball at the ball, and became quite a hit"},
    {"id":"b_story","text":"<strong>B Story:</strong> Meanwhile, the hero meets...whom? and does... what?","v":"Cinderella meets the prince who falls in love with her and wants to know her name"},
    {"id":"midpoint","text":"<strong>Midpont:</strong> Suddenly... What happens to the hero that prevents him/her from going forward towards the goal? This event must play favorably for the villain.","v":"It is midnight, and the coach turns into a pumpkin"},
    {"id":"bad_guys","text":"<strong>Bad guys close in:</strong> In what way the villain notices the hero as a nuisance? What does the villain do to brush the hero aside?","v":"Stepmother notices Cinderella's success and orders her to stay in house"},
    {"id":"b_evolve","text":"<strong>B Story evolves:</strong> How does this relationship evolve over time?","v":"The prince is looking for Cinderella all over the kingdom, trying the crystal shoe on all the unmarried young girls - the only clue he's got"},
    {"id":"cave","text":"<strong>Dark Night of the Soul:</strong> How does the villain nearly defeats the hero? What is hero's darkest moment?","v":"Cinderella cannot come out and meet the prince, who has tried the shoe on her step-sisters, but failed, and is about to leave"},
    {"id":"hero_need","text":"What is the hero's true need? (revelation)"},
    {"id":"b_end","text":"<strong>B Story Ends</strong> How does this relationship eventually help the hero at the end?","v":"Cinderella loves the prince, and decides to show up to prince's men despite her Stepmother's orders"},
    {"id":"battle","text":"<strong>Act III:</strong>The final battle: What are the smaller enemies the hero has to fight before getting to the villain?  How does the hero finally meet and defeat the villain? Or does the hero lose?","v":"Cinderella tries the shoe - and not only it fits, but she produces the second shoe, just like the first one"},
    {"id":"char_test","text":"The character test (if necessary): what does the hero do to demonstrate that he/she is now a different person?","v":"Cinderella agrees to marry the prince. and they live happily ever after"}
     ];

// Backward compatibility: alternative names of the field
var oldIds =
  { 'hero_want' : ['hero_goal'],
    'hero_need' : ['hero_goal']
  };

var treatment = 
  "<h3 id=\"treatment_title\">_title_</h3>"
  +"<p>Once upon a time there was a _hero_desc_ named _hero_name_. "
  +"_hero_routine_"
  +"<p>One day, _catalyst_."
  +"<p>_hero_name_ really wanted _hero_want_. But _hero_name_ _debate_. "
  +"<p>At the same time, _vil_desc_ _vil_name_  just as badly wanted _vil_goal_. _hero_name_ could do nothing about it, because _vil_name_ _vil_power_. "
  +"<p>Only with the help of _ally_ "
  +"_hero_name_ was still reluctantly considering _hero_want_."
  +"<p>At this point, _break2_."
  +"<p>_hero_name_ _fun_."
  +"<p>Meanwhile, _b_story_."
  +"<p>Everything seems to go well, but at this point, _midpoint_."
  +"<p>_vil_name_ is prevailing. _bad_guys_."
  +"<p>At the same time, _b_evolve_."
  +"<p>But things look truly bad for _hero_name_. _cave_"
  +"<p>In this dark moment, _hero_name_ realizes that deep down inside, he/she really needs _hero_need_."
  +"<p>Also, _b_end_. _hero_name_ now has new hope"
  +"<p>_hero_name_ is ready to face _vil_name_. _battle_."
  +"<p>It's all over. _char_test_."
  +"<p>THE END";

var db = { };
var currentStory = 0;
var stories = [ ];

function replacer(key, value) {
    if (typeof value === 'number' && !isFinite(value)) {
        return String(value);
    }
    return value;
}

function htmlEncode(s)
{
return s.replace(/&/g, "&amp;")
  .replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

function readDB(field) {
  if(typeof db != 'object') return '';
  if(typeof db[field] != 'object') {
    // Look for older versions
    if(typeof oldIds[field] == 'object') {
      var ids = oldIds[field];
      for(var i in ids) {
	var id = ids[i];
	if((typeof db[id] == 'object')
	   && (typeof db[id].v != 'undefined')) {
	  return db[id].v;
	}
      }
    }
    // no luck, return empty string
    return '';
  }
  if(typeof db[field].v == 'undefined') return '';
  return db[field].v;
}

function deleteFromDB(field) {
  if(typeof db != 'object') return;
  if(typeof db[field] != 'undefined') {
    delete db[field];
  }
}

function updateDB(field, value) {
  if(typeof value == 'undefined' || value == '') deleteFromDB(field);
  else {
    if(typeof db != 'object') {
      db = { };
    }
    db[field] = { 'v' : value };
  }
}

function traverse(o) {
  if(typeof o == 'object') {
    if(typeof(o.length) != 'undefined') { // array
      var acc = '[';
      for (var i=0; i<o.length; ++i) {
	acc += traverse(o[i])+",";
      }
      acc += ']';
      return acc;
    } else {
      var acc = '{';
      for (var i in o) {
	acc += "'"+i+"' : "+traverse(o[i])+",";
      }
      acc += '}';
      return acc;
    }
  } else {
    return "'"+escape(o)+"'";
  }
}

function printCode(db) {
  if(typeof(JSON) === 'object') {
    return JSON.stringify(db);
  } else
    {
      // return traverse(db);
      return 'Your browser is unsupported. You will not be able to save and restore your story.';
  }
}

function parseCode(str) {
  var res = db; // by default, return what's already in db
  if(typeof(JSON) == 'object') { return JSON.parse(str); }
  // FIXME: write a better parser, or give up
  //  else { return eval(unescape(str)); }
  return res;
}

function loadStory(i) {
  currentStory = i;
  db = stories[i];
  document.getElementById('json_text').value = printCode(db);
  updateFromCode(false);
}

function updateStory() {
  if(currentStory >= samples.length) {
    stories[currentStory] = db;
  }
}

function createStory(story) {
  var s = {"title":{"v":"Unnamed Story"}};
  if(typeof story == 'object') {
    // clone the object
    for(var key in story) {
      s[key] = { 'v': story[key].v };
    }
  }
  stories[stories.length] = s;
  loadStory([stories.length-1]);
}

function deleteStory(i) {
  if(confirm('Are you sure you want to delete '+stories[i].title.v+'?')) {
    for(var j=i; j<stories.length; ++j) {
      if(j+1<stories.length) stories[j] = stories[j+1];
      else stories.pop();
    }
  }
  if(currentStory >= stories.length) currentStory = stories.length-1;
  loadStory(currentStory);
}

function updateMenu() {
  var menu = '<ul>';
  for(var i=0; i<stories.length; ++i) {
    menuClass = (i==currentStory)? 'treatment_menu_item_active' : 'treatment_menu_item';
    menu += '<li class="'+menuClass+'" onclick="loadStory('+i+')"><a href="javascript:loadStory('+i+')">'
      +htmlEncode(stories[i].title.v)+'</a>'
      +((i<samples.length) ? '' : '<a class="delete" href="javascript:deleteStory('+i+')">X</a>')
      +"</li>\n";
  }
  menu += '<li><a class="treatment_menu_item" href="javascript:createStory()">Create New Story</a></li>';
  //  menu += '<li><a class="treatment_menu_item" href="javascript:clearAll()">Erase This Story</a></li>';
  menu += "</ul>\n";
  document.getElementById('treatment_menu').innerHTML = menu;
}

function initialize() {
  // Generate the core HTML
  document.getElementById('treatment_generator').innerHTML =
    '<link rel="stylesheet" href="/treatment-generator.css" type="text/css">'
    +'<div id="overlay" class="overlay"></div>'
    +'<div id="treatment_menu"></div>'
    +'<div id="json">'
    +'<h3>Story Code</h3>'
    +'<p>Copy and save this code on your computer, then paste it back here to restore your story'
    +'<textarea rows="10" cols="25" id="json_text" onkeyup="updateFromCode(true)" onclick="this.focus(); this.select()"></textarea>'
    +'</div>'
    +'<div id="questions"></div>'
    +'<div id="treatment"></div>';
    
  // Deep-copy samples to stories
  for(var i=0; i<samples.length; ++i) { stories[i] = samples[i]; }
  updateMenu();
  document.getElementById('json_text').value = printCode(db);
  var obj = document.getElementById('questions');
  for(var i=0; i<questions.length; ++i) {
    obj.innerHTML += "<p>"
      +questions[i]['text']
      +'<br/><textarea rows="3" cols="40" id="text_'+questions[i]['id']+'" onkeyup="updateAll()"></textarea></p>';
  }
  loadStory(0);
}

function clearAll() {
  if(currentStory < samples.length) {
    alert('Cannot erase a sample story '+stories[currentStory].title.v);
    return;
  }
  if(!confirm('Are you sure you want to erase '+stories[currentStory].title.v
	      +'? This action cannot be undone.')) {
    return;
  }
  for(var i=0; i<questions.length; ++i) {
    document.getElementById('text_'+questions[i]['id']).value = '';
  }
  updateAll();
}

function updateFromCode(createNew) {
  db = parseCode(document.getElementById('json_text').value);
  if(typeof db != 'object') return;
  var changed = false;
  for(var i=0; i<questions.length; ++i) {
    var str = readDB(questions[i].id);
    var obj = document.getElementById('text_'+questions[i].id);
    if(obj.value != str) {
      changed = true;
      obj.value = str;
    }
  }
  if(createNew && changed && currentStory < samples.length) {
    if(confirm('You are trying to modify a sample story. '
	       +'Would you like to create a new story based on this change?')) {
      createStory(db); // This call updates the screen
      return;
    }
  }
  updateAllAux(false /* no code update */, false /* dont create story */);
}

function updateAll() {
  updateAllAux(true, true);
}

// Compute the current treatment text from input fields, and update db if needed
function getTreatment() {
  var text = treatment;
  var changed = false;
  for(var i=questions.length-1; i>=0; --i) {
    var regexpr = new RegExp('_'+questions[i]['id']+'_', 'g');
    var v = document.getElementById('text_'+questions[i]['id']).value;
    if(v != readDB(questions[i].id)) { changed = true; }
    updateDB(questions[i].id, v);
    v = htmlEncode(v);
    text = text.replace(regexpr, v);
  }
  return {'text': text, 'changed' : changed };
}

function updateAllAux(updateCode, cloneStory) {
  var res = getTreatment();
  var text = res.text;
  var changed = res.changed;
  if(cloneStory && changed && currentStory < samples.length) {
    if(confirm('You are trying to modify a sample story. '
	       +'Would you like to create a new story based on this change?')) {
      createStory(db); // This call updates the screen
      return;
    }
  }
  var obj = document.getElementById('treatment');
  obj.innerHTML =
    '<button id="display_treatment_button" onclick="showTreatmentInOverlay()">Display in Overlay</button>'
    +text;
  if(updateCode) {
    document.getElementById('json_text').value = printCode(db);
  }
  updateStory();
  updateMenu();
}

/* Activate overlay and display 'html' in it */
function showOverlay(html) {
  var d = document.getElementById('overlay');
  if(d == null) {
    return;
  }
  d.style.display = 'block';
  d.innerHTML = '<div class="overlay_shadow"></div>'
    +'<div class="overlay_contents"><button onclick="hideOverlay()">Close</button>'
    +html+'</div>';
}

function hideOverlay() {
  var d = document.getElementById('overlay');
  if(d == null) {
    return;
  }
  d.style.display = 'none';
}

function showTreatmentInOverlay() {
  var text = getTreatment().text;
  showOverlay(text);
}

window.onload=initialize;
